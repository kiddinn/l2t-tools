rule System32BinaryOutsideOfWindowsDir
{
  meta:
    description = "A binary that should be running inside system32 appears in another location"
    case_nr = "ABC1234"

  strings:
    $sys = /(Windows|WINNT)\/system32\// nocase

    $exclude_hfmig = /(Windows|WINNT)\/\$hf_mig\$\// nocase
    $exclude_update = /(Windows|WINNT)\/\$[A-Z0-9]+~[0-9]\// nocase
    $exclude_uninstall = /(Windows|WINNT)\/\$NtUninstall/ nocase
    $exclude_syswow64 = /(Windows|WINNT)\/\SysWOW64/ nocase
    $exclude_winsxs = /(Windows|WINNT)\/\winsxs/ nocase

    $exe_accwiz = /\/accwiz(\[[0-9]\])?.exe/
    $exe_actmovie = /\/actmovie(\[[0-9]\])?.exe/
    $exe_ahui = /\/ahui(\[[0-9]\])?.exe/
    $exe_alg = /\/alg(\[[0-9]\])?.exe/
    $exe_append = /\/append(\[[0-9]\])?.exe/
    $exe_arp = /\/arp(\[[0-9]\])?.exe/
    $exe_asr_fmt = /\/asr_fmt(\[[0-9]\])?.exe/
    $exe_asr_ldm = /\/asr_ldm(\[[0-9]\])?.exe/
    $exe_asr_pfu = /\/asr_pfu(\[[0-9]\])?.exe/
    $exe_at = /\/at(\[[0-9]\])?.exe/
    $exe_atmadm = /\/atmadm(\[[0-9]\])?.exe/
    $exe_attrib = /\/attrib(\[[0-9]\])?.exe/
    $exe_auditusr = /\/auditusr(\[[0-9]\])?.exe/
    $exe_autochk = /\/autochk(\[[0-9]\])?.exe/
    $exe_autoconv = /\/autoconv(\[[0-9]\])?.exe/
    $exe_autofmt = /\/autofmt(\[[0-9]\])?.exe/
    $exe_bootcfg = /\/bootcfg(\[[0-9]\])?.exe/
    $exe_bootok = /\/bootok(\[[0-9]\])?.exe/
    $exe_bootvrfy = /\/bootvrfy(\[[0-9]\])?.exe/
    $exe_cacls = /\/cacls(\[[0-9]\])?.exe/
    $exe_calc = /\/calc(\[[0-9]\])?.exe/
    $exe_cfgwiz = /\/cfgwiz(\[[0-9]\])?.exe/
    $exe_change = /\/change(\[[0-9]\])?.exe/
    $exe_charmap = /\/charmap(\[[0-9]\])?.exe/
    $exe_chglogon = /\/chglogon(\[[0-9]\])?.exe/
    $exe_chgport = /\/chgport(\[[0-9]\])?.exe/
    $exe_chgusr = /\/chgusr(\[[0-9]\])?.exe/
    $exe_chkdsk = /\/chkdsk(\[[0-9]\])?.exe/
    $exe_chkntfs = /\/chkntfs(\[[0-9]\])?.exe/
    $exe_cidaemon = /\/cidaemon(\[[0-9]\])?.exe/
    $exe_cipher = /\/cipher(\[[0-9]\])?.exe/
    $exe_cisvc = /\/cisvc(\[[0-9]\])?.exe/
    $exe_cleanmgr = /\/cleanmgr(\[[0-9]\])?.exe/
    $exe_cliconfg = /\/cliconfg(\[[0-9]\])?.exe/
    $exe_clipbrd = /\/clipbrd(\[[0-9]\])?.exe/
    $exe_clipsrv = /\/clipsrv(\[[0-9]\])?.exe/
    $exe_cmd = /\/cmd(\[[0-9]\])?.exe/
    $exe_cmdl32 = /\/cmdl32(\[[0-9]\])?.exe/
    $exe_cmmon32 = /\/cmmon32(\[[0-9]\])?.exe/
    $exe_cmstp = /\/cmstp(\[[0-9]\])?.exe/
    $exe_compact = /\/compact(\[[0-9]\])?.exe/
    $exe_comp = /\/comp(\[[0-9]\])?.exe/
    $exe_comrepl = /\/comrepl(\[[0-9]\])?.exe/
    $exe_comrereg = /\/comrereg(\[[0-9]\])?.exe/
    $exe_conime = /\/conime(\[[0-9]\])?.exe/
    $exe_control = /\/control(\[[0-9]\])?.exe/
    $exe_convert = /\/convert(\[[0-9]\])?.exe/
    $exe_convlog = /\/convlog(\[[0-9]\])?.exe/
    $exe_cprofile = /\/cprofile(\[[0-9]\])?.exe/
    $exe_cscript = /\/cscript(\[[0-9]\])?.exe/
    $exe_csrss = /\/csrss(\[[0-9]\])?.exe/
    $exe_ctfmon = /\/ctfmon(\[[0-9]\])?.exe/
    $exe_davcdata = /\/davcdata(\[[0-9]\])?.exe/
    $exe_dcomcnfg = /\/dcomcnfg(\[[0-9]\])?.exe/
    $exe_defrag = /\/defrag(\[[0-9]\])?.exe/
    $exe_dfrgfat = /\/dfrgfat(\[[0-9]\])?.exe/
    $exe_dfrgntfs = /\/dfrgntfs(\[[0-9]\])?.exe/
    $exe_diskpart = /\/diskpart(\[[0-9]\])?.exe/
    $exe_diskperf = /\/diskperf(\[[0-9]\])?.exe/
    $exe_dllhost = /\/dllhost(\[[0-9]\])?.exe/
    $exe_dllhst3g = /\/dllhst3g(\[[0-9]\])?.exe/
    $exe_doskey = /\/doskey(\[[0-9]\])?.exe/
    $exe_dosx = /\/dosx(\[[0-9]\])?.exe/
    $exe_dplaysvr = /\/dplaysvr(\[[0-9]\])?.exe/
    $exe_dpnsvr = /\/dpnsvr(\[[0-9]\])?.exe/
    $exe_drwatson = /\/drwatson(\[[0-9]\])?.exe/
    $exe_drwtsn32 = /\/drwtsn32(\[[0-9]\])?.exe/
    $exe_dumprep = /\/dumprep(\[[0-9]\])?.exe/
    $exe_dvdplay = /\/dvdplay(\[[0-9]\])?.exe/
    $exe_dvdupgrd = /\/dvdupgrd(\[[0-9]\])?.exe/
    $exe_dwwin = /\/dwwin(\[[0-9]\])?.exe/
    $exe_dxdiag = /\/dxdiag(\[[0-9]\])?.exe/
    $exe_edlin = /\/edlin(\[[0-9]\])?.exe/
    $exe_esentutl = /\/esentutl(\[[0-9]\])?.exe/
    $exe_eudcedit = /\/eudcedit(\[[0-9]\])?.exe/
    $exe_eventvwr = /\/eventvwr(\[[0-9]\])?.exe/
    $exe_evntcmd = /\/evntcmd(\[[0-9]\])?.exe/
    $exe_evntwin = /\/evntwin(\[[0-9]\])?.exe/
    $exe_evtrig = /\/evtrig(\[[0-9]\])?.exe/
    $exe_exe2bin = /\/exe2bin(\[[0-9]\])?.exe/
    $exe_expand = /\/expand(\[[0-9]\])?.exe/
    $exe_extrac32 = /\/extrac32(\[[0-9]\])?.exe/
    $exe_fastopen = /\/fastopen(\[[0-9]\])?.exe/
    $exe_fc = /\/fc(\[[0-9]\])?.exe/
    $exe_find = /\/find(\[[0-9]\])?.exe/
    $exe_findstr = /\/findstr(\[[0-9]\])?.exe/
    $exe_finger = /\/finger(\[[0-9]\])?.exe/
    $exe_fixmapi = /\/fixmapi(\[[0-9]\])?.exe/
    $exe_fontview = /\/fontview(\[[0-9]\])?.exe/
    $exe_freecell = /\/freecell(\[[0-9]\])?.exe/
    $exe_fsquirt = /\/fsquirt(\[[0-9]\])?.exe/
    $exe_fsutil = /\/fsutil(\[[0-9]\])?.exe/
    $exe_ftp = /\/ftp(\[[0-9]\])?.exe/
    $exe_fxsclnt = /\/fxsclnt(\[[0-9]\])?.exe/
    $exe_fxscover = /\/fxscover(\[[0-9]\])?.exe/
    $exe_fxssend = /\/fxssend(\[[0-9]\])?.exe/
    $exe_fxssvc = /\/fxssvc(\[[0-9]\])?.exe/
    $exe_getmac = /\/getmac(\[[0-9]\])?.exe/
    $exe_gpresult = /\/gpresult(\[[0-9]\])?.exe/
    $exe_gpupdate = /\/gpupdate(\[[0-9]\])?.exe/
    $exe_grpconv = /\/grpconv(\[[0-9]\])?.exe/
    $exe_helpctr = /\/helpctr(\[[0-9]\])?.exe/
    $exe_help = /\/help(\[[0-9]\])?.exe/
    $exe_helphost = /\/helphost(\[[0-9]\])?.exe/
    $exe_hscupd = /\/hscupd(\[[0-9]\])?.exe/
    $exe_iexpress = /\/iexpress(\[[0-9]\])?.exe/
    $exe_iisreset = /\/iisreset(\[[0-9]\])?.exe/
    $exe_iisrstas = /\/iisrstas(\[[0-9]\])?.exe/
    $exe_iissync = /\/iissync(\[[0-9]\])?.exe/
    $exe_imapi = /\/imapi(\[[0-9]\])?.exe/
    $exe_inetmgr = /\/inetmgr(\[[0-9]\])?.exe/
    $exe_ipconfig = /\/ipconfig(\[[0-9]\])?.exe/
    $exe_ipsec6 = /\/ipsec6(\[[0-9]\])?.exe/
    $exe_ipv6 = /\/ipv6(\[[0-9]\])?.exe/
    $exe_krnl386 = /\/krnl386(\[[0-9]\])?.exe/
    $exe_label = /\/label(\[[0-9]\])?.exe/
    $exe_lhmstsc = /\/lhmstsc(\[[0-9]\])?.exe/
    $exe_lnkstub = /\/lnkstub(\[[0-9]\])?.exe/
    $exe_lodctr = /\/lodctr(\[[0-9]\])?.exe/
    $exe_logagent = /\/logagent(\[[0-9]\])?.exe/
    $exe_logman = /\/logman(\[[0-9]\])?.exe/
    $exe_logoff = /\/logoff(\[[0-9]\])?.exe/
    $exe_logonui = /\/logonui(\[[0-9]\])?.exe/
    $exe_lpq = /\/lpq(\[[0-9]\])?.exe/
    $exe_lpr = /\/lpr(\[[0-9]\])?.exe/
    $exe_lsass = /\/lsass(\[[0-9]\])?.exe/
    $exe_magnify = /\/magnify(\[[0-9]\])?.exe/
    $exe_makecab = /\/makecab(\[[0-9]\])?.exe/
    $exe_mmc = /\/mmc(\[[0-9]\])?.exe/
    $exe_mobsync = /\/mobsync(\[[0-9]\])?.exe/
    $exe_mofcomp = /\/mofcomp(\[[0-9]\])?.exe/
    $exe_mountvol = /\/mountvol(\[[0-9]\])?.exe/
    $exe_mpnotify = /\/mpnotify(\[[0-9]\])?.exe/
    $exe_mqbkup = /\/mqbkup(\[[0-9]\])?.exe/
    $exe_mqsvc = /\/mqsvc(\[[0-9]\])?.exe/
    $exe_mqtgsvc = /\/mqtgsvc(\[[0-9]\])?.exe/
    $exe_mrinfo = /\/mrinfo(\[[0-9]\])?.exe/
    $exe_MRT = /\/MRT(\[[0-9]\])?.exe/
    $exe_mscdexnt = /\/mscdexnt(\[[0-9]\])?.exe/
    $exe_msdtc = /\/msdtc(\[[0-9]\])?.exe/
    $exe_msg = /\/msg(\[[0-9]\])?.exe/
    $exe_mshearts = /\/mshearts(\[[0-9]\])?.exe/
    $exe_msiexec = /\/msiexec(\[[0-9]\])?.exe/
    $exe_nbtstat = /\/nbtstat(\[[0-9]\])?.exe/
    $exe_net1 = /\/net1(\[[0-9]\])?.exe/
    $exe_net = /\/net(\[[0-9]\])?.exe/
    $exe_netsh = /\/netsh(\[[0-9]\])?.exe/
    $exe_netstat = /\/netstat(\[[0-9]\])?.exe/
    $exe_nlsfunc = /\/nlsfunc(\[[0-9]\])?.exe/
    $exe_notepad = /\/notepad(\[[0-9]\])?.exe/
    $exe_nslookup = /\/nslookup(\[[0-9]\])?.exe/
    $exe_ntbackup = /\/ntbackup(\[[0-9]\])?.exe/
    $exe_ntkrnlpa = /\/ntkrnlpa(\[[0-9]\])?.exe/
    $exe_ntoskrnl = /\/ntoskrnl(\[[0-9]\])?.exe/
    $exe_ntvdm = /\/ntvdm(\[[0-9]\])?.exe/
    $exe_odbcad32 = /\/odbcad32(\[[0-9]\])?.exe/
    $exe_openfiles = /\/openfiles(\[[0-9]\])?.exe/
    $exe_perfmon = /\/perfmon(\[[0-9]\])?.exe/
    $exe_pinball = /\/pinball(\[[0-9]\])?.exe/
    $exe_ping6 = /\/ping6(\[[0-9]\])?.exe/
    $exe_ping = /\/ping(\[[0-9]\])?.exe/
    $exe_powercfg = /\/powercfg(\[[0-9]\])?.exe/
    $exe_print = /\/print(\[[0-9]\])?.exe/
    $exe_proquota = /\/proquota(\[[0-9]\])?.exe/
    $exe_proxycfg = /\/proxycfg(\[[0-9]\])?.exe/
    $exe_qappsrv = /\/qappsrv(\[[0-9]\])?.exe/
    $exe_qprocess = /\/qprocess(\[[0-9]\])?.exe/
    $exe_query = /\/query(\[[0-9]\])?.exe/
    $exe_quser = /\/quser(\[[0-9]\])?.exe/
    $exe_qwinsta = /\/qwinsta(\[[0-9]\])?.exe/
    $exe_rasautou = /\/rasautou(\[[0-9]\])?.exe/
    $exe_rasdial = /\/rasdial(\[[0-9]\])?.exe/
    $exe_rasphone = /\/rasphone(\[[0-9]\])?.exe/
    $exe_rcimlby = /\/rcimlby(\[[0-9]\])?.exe/
    $exe_rdpclip = /\/rdpclip(\[[0-9]\])?.exe/
    $exe_rdsaddin = /\/rdsaddin(\[[0-9]\])?.exe/
    $exe_recover = /\/recover(\[[0-9]\])?.exe/
    $exe_redir = /\/redir(\[[0-9]\])?.exe/
    $exe_regini = /\/regini(\[[0-9]\])?.exe/
    $exe_reg = /\/reg(\[[0-9]\])?.exe/
    $exe_regsvr32 = /\/regsvr32(\[[0-9]\])?.exe/
    $exe_relog = /\/relog(\[[0-9]\])?.exe/
    $exe_replace = /\/replace(\[[0-9]\])?.exe/
    $exe_reset = /\/reset(\[[0-9]\])?.exe/
    $exe_robocopy = /\/robocopy(\[[0-9]\])?.exe/
    $exe_route = /\/route(\[[0-9]\])?.exe/
    $exe_rsvp = /\/rsvp(\[[0-9]\])?.exe/
    $exe_runas = /\/runas(\[[0-9]\])?.exe/
    $exe_rundll32 = /\/rundll32(\[[0-9]\])?.exe/
    $exe_runonce = /\/runonce(\[[0-9]\])?.exe/
    $exe_rvsezm = /\/rvsezm(\[[0-9]\])?.exe/
    $exe_rwinsta = /\/rwinsta(\[[0-9]\])?.exe/
    $exe_scardsvr = /\/scardsvr(\[[0-9]\])?.exe/
    $exe_schtasks = /\/schtasks(\[[0-9]\])?.exe/
    $exe_scrcons = /\/scrcons(\[[0-9]\])?.exe/
    $exe_sc = /\/sc(\[[0-9]\])?.exe/
    $exe_sdbinst = /\/sdbinst(\[[0-9]\])?.exe/
    $exe_secedit = /\/secedit(\[[0-9]\])?.exe/
    $exe_services = /\/services(\[[0-9]\])?.exe/
    $exe_sessmgr = /\/sessmgr(\[[0-9]\])?.exe/
    $exe_sethc = /\/sethc(\[[0-9]\])?.exe/
    $exe_setver = /\/setver(\[[0-9]\])?.exe/
    $exe_sfc = /\/sfc(\[[0-9]\])?.exe/
    $exe_shadow = /\/shadow(\[[0-9]\])?.exe/
    $exe_share = /\/share(\[[0-9]\])?.exe/
    $exe_shrpubw = /\/shrpubw(\[[0-9]\])?.exe/
    $exe_shutdown = /\/shutdown(\[[0-9]\])?.exe/
    $exe_sigverif = /\/sigverif(\[[0-9]\])?.exe/
    $exe_smss = /\/smss(\[[0-9]\])?.exe/
    $exe_sndrec32 = /\/sndrec32(\[[0-9]\])?.exe/
    $exe_sndvol32 = /\/sndvol32(\[[0-9]\])?.exe/
    $exe_snmp = /\/snmp(\[[0-9]\])?.exe/
    $exe_snmptrap = /\/snmptrap(\[[0-9]\])?.exe/
    $exe_sol = /\/sol(\[[0-9]\])?.exe/
    $exe_sort = /\/sort(\[[0-9]\])?.exe/
    $exe_spider = /\/spider(\[[0-9]\])?.exe/
    $exe_svchost = /\/svchost(\[[0-9]\])?.exe/
    $exe_sysedit = /\/sysedit(\[[0-9]\])?.exe/
    $exe_syskey = /\/syskey(\[[0-9]\])?.exe/
    $exe_systeminfo = /\/systeminfo(\[[0-9]\])?.exe/
    $exe_systray = /\/systray(\[[0-9]\])?.exe/
    $exe_taskkill = /\/taskkill(\[[0-9]\])?.exe/
    $exe_tasklist = /\/tasklist(\[[0-9]\])?.exe/
    $exe_taskman = /\/taskman(\[[0-9]\])?.exe/
    $exe_taskmgr = /\/taskmgr(\[[0-9]\])?.exe/
    $exe_tcmsetup = /\/tcmsetup(\[[0-9]\])?.exe/
    $exe_tcpsvcs = /\/tcpsvcs(\[[0-9]\])?.exe/
    $exe_telnet = /\/telnet(\[[0-9]\])?.exe/
    $exe_tftp = /\/tftp(\[[0-9]\])?.exe/
    $exe_tintlphr = /\/tintlphr(\[[0-9]\])?.exe/
    $exe_tintsetp = /\/tintsetp(\[[0-9]\])?.exe/
    $exe_tlntadmn = /\/tlntadmn(\[[0-9]\])?.exe/
    $exe_tlntsess = /\/tlntsess(\[[0-9]\])?.exe/
    $exe_tlntsvr = /\/tlntsvr(\[[0-9]\])?.exe/
    $exe_tracerpt = /\/tracerpt(\[[0-9]\])?.exe/
    $exe_tracert6 = /\/tracert6(\[[0-9]\])?.exe/
    $exe_tracert = /\/tracert(\[[0-9]\])?.exe/
    $exe_tscon = /\/tscon(\[[0-9]\])?.exe/
    $exe_tsdiscon = /\/tsdiscon(\[[0-9]\])?.exe/
    $exe_tskill = /\/tskill(\[[0-9]\])?.exe/
    $exe_TsWpfWrp = /\/TsWpfWrp(\[[0-9]\])?.exe/
    $exe_typeperf = /\/typeperf(\[[0-9]\])?.exe/
    $exe_unlodctr = /\/unlodctr(\[[0-9]\])?.exe/
    $exe_unsecapp = /\/unsecapp(\[[0-9]\])?.exe/
    $exe_upnpcont = /\/upnpcont(\[[0-9]\])?.exe/
    $exe_userinit = /\/userinit(\[[0-9]\])?.exe/
    $exe_utilman = /\/utilman(\[[0-9]\])?.exe/
    $exe_uwdf = /\/uwdf(\[[0-9]\])?.exe/
    $exe_verclsid = /\/verclsid(\[[0-9]\])?.exe/
    $exe_verifier = /\/verifier(\[[0-9]\])?.exe/
    $exe_vssadmin = /\/vssadmin(\[[0-9]\])?.exe/
    $exe_vssvc = /\/vssvc(\[[0-9]\])?.exe/
    $exe_w32tm = /\/w32tm(\[[0-9]\])?.exe/
    $exe_wbemtest = /\/wbemtest(\[[0-9]\])?.exe/
    $exe_wdfmgr = /\/wdfmgr(\[[0-9]\])?.exe/
    $exe_wextract = /\/wextract(\[[0-9]\])?.exe/
    $exe_WgaTray = /\/WgaTray(\[[0-9]\])?.exe/
    $exe_wiaacmgr = /\/wiaacmgr(\[[0-9]\])?.exe/
    $exe_winlogon = /\/winlogon(\[[0-9]\])?.exe/
    $exe_winspool = /\/winspool(\[[0-9]\])?.exe/
    $exe_winver = /\/winver(\[[0-9]\])?.exe/
    $exe_wmiadap = /\/wmiadap(\[[0-9]\])?.exe/
    $exe_wmic = /\/wmic(\[[0-9]\])?.exe/
    $exe_wmiprvse = /\/wmiprvse(\[[0-9]\])?.exe/
    $exe_wowdeb = /\/wowdeb(\[[0-9]\])?.exe/
    $exe_wowexec = /\/wowexec(\[[0-9]\])?.exe/
    $exe_wscntfy = /\/wscntfy(\[[0-9]\])?.exe/
    $exe_wscript = /\/wscript(\[[0-9]\])?.exe/
    $exe_wuauclt = /\/wuauclt(\[[0-9]\])?.exe/
    $exe_WudfHost = /\/WudfHost(\[[0-9]\])?.exe/
    $exe_wupdmgr = /\/wupdmgr(\[[0-9]\])?.exe/
    $exe_xcopy = /\/xcopy(\[[0-9]\])?.exe/
    $exe_XPSViewer = /\/XPSViewer(\[[0-9]\])?.exe/

  condition:
    MFT_Hit and not $sys and not 1 of ($exclude_*) and 1 of ($exe_*)
}

